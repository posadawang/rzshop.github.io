<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>商品詳情｜阿智小舖</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/rzshop.github.io/assets/styles.css" rel="stylesheet">
</head>
<body>

<!-- ✅ 導覽列（含購物車顯示） -->
<nav class="navbar navbar-expand-lg bg-body-tertiary sticky-top shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/rzshop.github.io/">
      <img src="/rzshop.github.io/assets/images/rzshopp.jpg" alt="" width="28" height="28" class="me-2">
      阿智小舖
    </a>
    <div class="ms-auto">
      <a href="/rzshop.github.io/checkout.html" class="btn btn-outline-primary position-relative">
        購物車
        <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
      </a>
    </div>
  </div>
</nav>

<header class="py-4 bg-dark text-white">
  <div class="container">
    <h1 class="h4 mb-0">商品詳情</h1>
  </div>
</header>

<main class="py-4">
  <div class="container" id="productContainer">
    <div class="text-center text-muted my-5">載入中…</div>
  </div>
</main>

<footer class="py-4 border-top text-center small">
  <div class="container">© <span id="year"></span> 阿智小舖</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ===== 購物車核心功能 ===== */
(function(){
  const CART_KEY = 'rzshop_cart';
  window.Cart = {
    key: CART_KEY,
    get(){ try { return JSON.parse(localStorage.getItem(CART_KEY)||'[]'); } catch(e){ return []; } },
    set(list){ localStorage.setItem(CART_KEY, JSON.stringify(list||[])); },
    add(item){
      const cart = this.get();
      const idx = cart.findIndex(x => x.id === item.id);
      if(idx>-1){ cart[idx].qty += (item.qty||1); } 
      else { cart.push({...item, qty:item.qty||1}); }
      this.set(cart);
      return cart;
    },
    clear(){ localStorage.removeItem(CART_KEY); },
    total(){ return this.get().reduce((t,i)=>t+i.price*i.qty,0); }
  };
})();

/* ===== 年份顯示 ===== */
document.addEventListener('DOMContentLoaded',()=>{
  const y=document.getElementById('year');
  if(y) y.textContent=new Date().getFullYear();
});

/* ===== 商品資料載入與按鈕功能 ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  const host = '/rzshop.github.io';
  const el = document.getElementById('productContainer');
  const id = new URLSearchParams(location.search).get('id');
  if(!id){ el.innerHTML='<div class="alert alert-danger">無效的商品連結</div>'; return; }

  const res = await fetch(`${host}/data/items.json?ts=${Date.now()}`);
  const items = await res.json();
  const item = items.find(x=>String(x.id)===id);
  if(!item){ el.innerHTML='<div class="alert alert-warning">找不到商品</div>'; return; }

  el.innerHTML = `
    <div class="row g-4">
      <div class="col-lg-6">
        <img src="${host}/${item.thumbnail}" class="img-fluid rounded w-100 mb-3">
      </div>
      <div class="col-lg-6">
        <h2>${item.title}</h2>
        <div class="text-primary fs-4 mb-3">$${item.price}</div>
        <p>${item.description||''}</p>
        <div class="input-group mb-3" style="max-width:200px">
          <span class="input-group-text">數量</span>
          <input id="qtyInput" type="number" min="1" value="1" class="form-control text-end">
        </div>
        <button id="addBtn" class="btn btn-primary">加入購物車</button>
        <a href="/rzshop.github.io/checkout.html" class="btn btn-outline-secondary ms-2">前往結帳</a>
      </div>
    </div>
  `;

  // 加入購物車按鈕
  el.querySelector('#addBtn').addEventListener('click',()=>{
    const qty = Math.max(1, Number(document.getElementById('qtyInput').value)||1);
    Cart.add({id:item.id,title:item.title,price:item.price,thumbnail:item.thumbnail,qty});
    alert('已加入購物車！');
    updateBadge();
  });

  updateBadge();
});

/* ===== 購物車徽章數量 ===== */
function updateBadge(){
  const badge = document.getElementById('cartCount');
  if(!badge) return;
  const total = Cart.get().reduce((s,i)=>s+i.qty,0);
  badge.textContent = total;
}
</script>
</body>
</html>
